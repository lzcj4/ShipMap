<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>船舶北斗定位</title>

    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.4.0&key=e74bfa8a52be17be2435ebfa02081c79&&plugin=AMap.Scale,AMap.OverView,AMap.ToolBar"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    {% block header %}
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static "css/bootstrap.min.css" %}"/>
        <link rel="stylesheet" type="text/css" href="{% static "css/div_style.css" %}"/>

        <script src="{% static "js/jquery.min.js" %}"></script>
        <script src="{% static "js/vue.min.js" %}"></script>
        <script src="{% static "js/utils.js" %}"></script>
        <script src="{% static "js/map.toolbar.js" %}"></script>
        <script src="{% static "js/bootstrap.min.js" %}"></script>
    {% endblock header %}
</head>

<body>

<div id="container" class="container"></div>

<div id="myPageTop">
    <table>
        <tr>
            <td>
                <label>按关键字搜索：</label>
            </td>
            <td class="column2">
                <label>左击获取经纬度：</label>
            </td>
            <td class="column2">
                <label>搜索半径：(米)</label>
            </td>
        </tr>
        <tr>
            <td>
                <input class="form-control" type="text" placeholder="请输入关键字进行搜索" id="tipinput">
            </td>
            <td class="column2">
                <input class="form-control" type="text" id="lnglat">
            </td>
            <td class="column2">
                <input class="form-control" type="text" id="txtRadius" v-model="circleRadius"/>
            </td>
        </tr>
    </table>
</div>
{#<div class='button-group' style="background-color: #0d9bf2;right: 20px">#}
{#    <input type="checkbox" onclick="toggleScale(this)"/>比例尺#}
{#    <input type="checkbox" id="toolbar" onclick="toggleToolBar(this)"/>工具条#}
{#    <input type="checkbox" id="toolbarDirection" disabled onclick="toggleToolBarDirection(this)"/>工具条方向盘#}
{#    <input type="checkbox" id="toolbarRuler" disabled onclick="toggleToolBarRuler(this)"/>工具条标尺#}
{#    <input type="checkbox" id="overview" onclick="toggleOverViewShow(this)"/>显示鹰眼#}
{#    <input type="checkbox" id="overviewOpen" disabled onclick="toggleOverViewOpen(this)"/>展开鹰眼#}
{#</div>#}

{% load static %}

<script>

    'use strict';

    function openWebSocket() {
        var socket = new WebSocket("ws://" + window.location.host + "/");
        socket.onmessage = function (e) {
            try {
                var pos = JSON.parse(e.data);
                addShip([pos.longitude, pos.latitude], 0)
            }
            catch (ex) {
                console.log("json parse:" + e.data + ",failed:" + ex.toString());
            }
        }
        socket.onopen = function () {
            socket.send("start new connection");
        }
    }

    // Call onopen directly if socket is already open
    var map = new AMap.Map("container", {
        resizeEnable: true,
        zoom: 13
    });

    //为地图注册click事件获取鼠标点击出的经纬度坐标
    map.on('click', function (e) {
        $("#lnglat").val(e.lnglat.getLng() + ',' + e.lnglat.getLat());
    });
    var circle;
    var shipList = [];

    function setRadiusChange(newRadius) {
        try {
            var r = parseFloat(newRadius);
            if (r != circle.getRadius()) {
                circle.setRadius(r);
                checkAllShipInRange();
            }
        }
        catch (ex) {
        }
    }

    function checkAllShipInRange() {
        for (var index in shipList) {
            var ship = shipList[index];
            setShipIcon(circle, ship)
        }
    }

    function setShipIcon(circle, ship) {
        if (checkElementIsNone(circle) || checkElementIsNone(ship)) {
            return;
        }
        ship.setIcon(circle.contains(ship.getPosition()) ?
            "http://oyjbgqiy4.bkt.clouddn.com/ship.png" : "http://oyjbgqiy4.bkt.clouddn.com/redboat.png");
    }

    map.plugin('AMap.Geolocation', function () {
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
            maximumAge: 0,           //定位结果缓存0毫秒，默认：0
            convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
            showButton: true,        //显示定位按钮，默认：true
            buttonPosition: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            showMarker: true,        //定位成功后在定位到的位置显示点标记，默认：true
            showCircle: true,        //定位成功后用圆圈表示定位精度范围，默认：true
            panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
            zoomToAccuracy: true      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition(function (status, geoResult) {
            circle = addCircle(geoResult.position, $("#txtRadius").val());
            addShip(geoResult.position, 0)
            addShip([geoResult.position.getLng() + 0.002, geoResult.position.getLat() + 0.002], 1)
        });
    });

    function addCircle(pos, radius) {
        var circle = new AMap.Circle({
            bubble: false,
            map: map,
            center: pos,        //设置线覆盖物路径
            radius: radius,//米
            strokeColor: "#3366FF", //边框线颜色
            strokeOpacity: 0.3,       //边框线透明度
            strokeWeight: 3,        //边框线宽
            fillColor: "#FFA500", //填充色
            fillOpacity: 0.35//填充透明度
        });
        {#        http://lbs.amap.com/api/javascript-api/reference/plugin#AMap.CircleEditor#}
        circle.on('dblclick', function (e) {
            map.plugin(["AMap.CircleEditor"], function (e) {
                var ce = new AMap.CircleEditor(map, circle);
                circle.setExtData({editor: ce});
                ce.open();
            });
        });
        circle.on('rightclick', function (e) {
            if (circle.getExtData().editor) {
                circle.getExtData().editor.close();
            }
        });

        circle.on('change', function (e) {
            checkAllShipInRange();
            $("#txtRadius").val(circle.getRadius());
        });
        return circle;
    }

    function addShip(pos, color) {
        var ship = new AMap.Marker({
            {#            draggable:true,#}
            position: pos,
            title: color == 0 ? "已方船只" : "未知船只"
        });
        ship.setMap(map);
        ship.on('click', function () {
            infoWindow.open(map, ship.getPosition());
        });
        {#        AMap.event.addListener(ship, 'click', function () {#}
        {#            infoWindow.open(map, ship.getPosition());#}
        {#        });#}

        setShipIcon(circle, ship);
        shipList.push(ship);
    }

    var title = '哈哈<span style="font-size:11px;color:#F00;">小三贼船</span>';
    var content = [];
    content.push("<img src='http://tpc.googlesyndication.com/simgad/5843493769827749134'>地址：北京市朝阳区阜通东大街6号院3号楼东北8.3公里");
    content.push("电话：010-64733333");
    content.push("<a href='http://ditu.amap.com/detail/B000A8URXB?citycode=110105'>详细信息</a>");
    var infoWindow = new AMap.InfoWindow({
        isCustom: true,  //使用自定义窗体
        content: createInfoWindow(title, content.join("<br/>")),
        offset: new AMap.Pixel(16, -45)
    });

    //关闭信息窗体
    function closeInfoWindow() {
        map.clearInfoWindow();
    }

    var scale = new AMap.Scale({
        visible: false
    });
    var toolBar = new AMap.ToolBar({
        visible: false
    });
    var overView = new AMap.OverView({
        visible: false
    });

    map.addControl(scale);
    map.addControl(toolBar);
    map.addControl(overView);

    AMap.plugin(['AMap.ToolBar'], function () {
        map.addControl(new AMap.ToolBar({
            map: map
        }));
    });

    var app = new Vue({
        el: '#myPageTop',
        data: {
            circleRadius: 150,
        },
        watch: {
            circleRadius: setRadiusChange,
        }
    })
    openWebSocket();
</script>
</body>
</html>